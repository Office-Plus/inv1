<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gate Pass</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }

        .header {
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 900;
        }

        .menu-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #2196F3;
        }

        .welcome-message {
            color: #333;
            font-size: 16px;
        }

        .container {
            max-width: 1200px;
            margin: 70px auto 0;
            padding: 20px;
        }

        .form-container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: bold;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
        }

        .form-group input[readonly] {
            background-color: #f9f9f9;
            color: #666;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
            margin-right: 10px;
        }

        .btn-primary {
            background-color: #2196F3;
            color: white;
        }

        .btn-primary:hover {
            background-color: #1976D2;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #545b62;
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin: 30px 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #2196F3;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 4px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        .notification.success { background-color: rgba(76, 175, 80, 0.9); }
        .notification.error { background-color: rgba(244, 67, 54, 0.9); }

        .searchable-hint {
            font-size: 12px;
            color: #777;
            margin-top: 6px;
        }

        /* Searchable dropdown */
        .searchable-dropdown {
            position: relative;
        }

        .searchable-dropdown input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .dropdown-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }

        .dropdown-item:hover {
            background-color: #f5f5f5;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        /* Global right-side search panel */
        .right-search-panel {
            position: fixed;
            top: 70px;
            right: 0;
            bottom: 0;
            width: min(520px, 45vw);
            background: #f0f0f0;
            border-left: 1px solid #ddd;
            box-shadow: -2px 0 6px rgba(0,0,0,0.08);
            overflow-y: auto;
            display: none;
            z-index: 1500;
        }
        .right-search-panel.show { display: block; }
        .right-search-header { display:flex; align-items:center; justify-content:space-between; gap:10px; padding: 10px 12px; font-weight: bold; color: #333; border-bottom: 1px solid #ddd; background: #fafafa; position: sticky; top: 0; }
        .right-search-meta { font-weight: normal; color:#555; font-size: 12px; }
        .right-search-actions { display:flex; align-items:center; gap:8px; }
        .refresh-btn-inline { cursor:pointer; border:none; background:#eee; padding:4px 8px; border-radius:4px; }
        .refresh-btn-inline:hover { background:#e0e0e0; }
        .right-search-hint { font-weight: normal; color:#8a6d3b; background:#fff3cd; border:1px solid #ffeeba; padding:4px 8px; border-radius:4px; margin-left:auto; }
        .right-search-list { list-style: none; margin: 0; padding: 0; }
        .right-search-item { padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #e6e6e6; outline: none; }
        .right-search-item:hover, .right-search-item:focus { background: #e7e7e7; }
        .right-search-item.active { background: #fff3cd; }

        .field-error {
            color: #dc3545;
            font-size: 12px;
            margin-top: 2px;
        }

        /* Tab styles */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            color: #666;
            font-size: 16px;
            position: relative;
        }

        .tab.active {
            color: #2196F3;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: #2196F3;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Table styles */
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f5f5f5;
            font-weight: 600;
            color: #333;
        }

        tr:hover {
            background-color: #f9f9f9;
        }

        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            margin: 0 2px;
            border-radius: 3px;
            font-size: 16px;
        }

        .edit-btn:hover {
            background-color: #e3f2fd;
        }

        .delete-btn:hover {
            background-color: #ffebee;
        }

        /* Search filters */
        .search-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-filters input,
        .search-filters select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .search-filters button {
            padding: 8px 16px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .search-filters button:hover {
            background-color: #1976D2;
        }

        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }

        .no-more {
            text-align: center;
            padding: 20px;
            color: #666;
            display: none;
        }
    </style>
</head>
<body>
    <div id="menuContainer"></div>

    <div class="header">
        <button class="menu-btn" onclick="toggleMenu()">‚ò∞</button>
        <div class="welcome-message" id="welcomeMessage"></div>
    </div>

    <div class="container">
        <h1>Gate Pass</h1>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('form')">Add/Edit Gate Pass</button>
            <button class="tab" onclick="switchTab('list')">Gate Pass List</button>
        </div>

        <div id="formTab" class="tab-content active">
            <div class="form-container">
            <form id="gatePassForm">
                <input type="hidden" id="itemDocId">
                <input type="hidden" id="itemIdHidden">
                <input type="hidden" id="partyDocId">
                <input type="hidden" id="partyCodeHidden">
                <div class="section-title">Gate Pass Details</div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="gatePassNo">Gate Pass No <span class="required">*</span></label>
                        <input type="text" id="gatePassNo" readonly>
                        <div class="searchable-hint">Auto-generated and unique</div>
                    </div>
                    <div class="form-group">
                        <label for="type">Type <span class="required">*</span></label>
                        <select id="type" required>
                            <option value="">Select Type</option>
                            <option value="IN">IN</option>
                            <option value="OUT">OUT</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="returnable">Returnable <span class="required">*</span></label>
                        <select id="returnable" required>
                            <option value="">Select Returnable</option>
                            <option value="RETURNABLE">RETURNABLE</option>
                            <option value="NON_RETURNABLE">NON RETURNABLE</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="itemName">Item Name <span class="required">*</span></label>
                        <div class="searchable-dropdown">
                            <input type="text" id="itemName" placeholder="Search and select item..." required>
                            <div class="dropdown-list" id="itemDropdown"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="itemCode">Item Code</label>
                        <input type="text" id="itemCode" readonly>
                    </div>
                    <div class="form-group">
                        <label for="partyName">Party Name <span class="required">*</span></label>
                        <input type="text" id="partyName" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="remarks">Remarks</label>
                        <textarea id="remarks" placeholder="Enter remarks..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="status">Store In</label>
                        <input type="text" id="status" value="PENDING" readonly>
                    </div>
                </div>

                <div class="form-actions" style="text-align:center; margin-top: 10px;">
                    <button type="submit" class="btn btn-primary" id="saveBtn">Save Gate Pass</button>
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">Reset</button>
                </div>
            </form>
            </div>
        </div>

        <div id="listTab" class="tab-content">
            <div class="search-filters">
                <input type="text" id="searchPartyName" placeholder="Search by party name...">
                <input type="text" id="searchItemName" placeholder="Search by item name...">
                <input type="text" id="searchGatePassNo" placeholder="Search by gate pass no...">
                <select id="searchType">
                    <option value="">All Types</option>
                    <option value="IN">IN</option>
                    <option value="OUT">OUT</option>
                </select>
                <select id="searchReturnable">
                    <option value="">All Returnable</option>
                    <option value="RETURNABLE">RETURNABLE</option>
                    <option value="NON_RETURNABLE">NON RETURNABLE</option>
                </select>
                <select id="searchStatus">
                    <option value="">All Status</option>
                    <option value="PENDING">PENDING</option>
                    <option value="APPROVED">APPROVED</option>
                    <option value="REJECTED">REJECTED</option>
                </select>
                <button id="searchBtn">Search</button>
                <button id="refreshBtn">Refresh</button>
                <button id="downloadExcelBtn">Download Excel</button>
            </div>

            <table id="gatePassTable">
                <thead>
                    <tr>
                        <th>Gate Pass No</th>
                        <th>Party Name</th>
                        <th>Item Name</th>
                        <th>Item Code</th>
                        <th>Type</th>
                        <th>Returnable</th>
                        <th>Status</th>
                        <th>Remarks</th>
                        <th>Created By</th>
                        <th>Created At</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="gatePassTableBody">
                    <tr>
                        <td colspan="11" style="text-align: center; padding: 20px;">No gate passes found</td>
                    </tr>
                </tbody>
            </table>

            <div id="loading" class="loading">Loading...</div>
            <div id="noMore" class="no-more">No more gate passes to load</div>
        </div>
    </div>

    <div id="notification" class="notification">
        <i class="fas fa-check-circle"></i>
        <span id="notificationMessage"></span>
    </div>

    <!-- Right-side search panel -->
    <div id="searchPanel" class="right-search-panel" tabindex="-1">
        <div id="searchPanelHeader" class="right-search-header">
            <span id="searchPanelTitle"></span>
            <span id="searchPanelMeta" class="right-search-meta"></span>
            <button id="searchPanelRefresh" class="refresh-btn-inline" title="Refresh">üîÑ Refresh</button>
            <span id="searchPanelHint" class="right-search-hint" style="display:none;"></span>
        </div>
        <ul id="searchPanelList" class="right-search-list"></ul>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js';
        import { getAuth } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js';
        import { getFirestore, collection, doc, getDoc, getDocs, query, where, orderBy, addDoc, updateDoc, deleteDoc, limit as qLimit, startAfter as qStartAfter } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js';
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-storage.js';
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBvTaQfcJsj7nGSOQxEdLjCbCenmDEC3Ns",
            authDomain: "lovable-9c76e.firebaseapp.com",
            projectId: "lovable-9c76e",
            storageBucket: "lovable-9c76e.firebasestorage.app",
            messagingSenderId: "670985612758",
            appId: "1:670985612758:web:67928f8e0328d54c640877",
            measurementId: "G-Q4X9B5HPJP"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app, 'invabrar');
        const auth = getAuth(app);
        const storage = getStorage(app);

        // Make Firebase objects globally available
        window.db = db;
        window.auth = auth;
        window.storage = storage;
        window.collection = collection;
        window.doc = doc;
        window.getDoc = getDoc;
        window.getDocs = getDocs;
        window.query = query;
        window.where = where;
        window.orderBy = orderBy;
        window.addDoc = addDoc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.qLimit = qLimit;
        window.qStartAfter = qStartAfter;
        window.storageRef = storageRef;
        window.uploadBytes = uploadBytes;
        window.getDownloadURL = getDownloadURL;
        window.deleteObject = deleteObject;
    </script>

    <!-- Menu / Version Management -->
    <script src="menu.js"></script>
    <script src="universal-menu-init.js"></script>

    <script>

        // Local caches for searchables
        let itemsArray = [];
        let partyArray = [];
        let partiesCache = [];

        // List management variables
        let isLoading = false;
        let hasMore = true;
        let lastVisible = null;
        let currentFilters = {
            partyName: '',
            itemName: '',
            gatePassNo: '',
            type: '',
            returnable: '',
            status: ''
        };

        function loadMenu() {
            fetch('menu.html')
                .then(r => r.text())
                .then(html => { document.getElementById('menuContainer').innerHTML = html; });
        }

        // Switch tabs
        window.switchTab = function(tab) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(t => {
                t.classList.remove('active');
            });
            
            document.getElementById(tab + 'Tab').classList.add('active');
            document.querySelector(`.tab[onclick="switchTab('${tab}')"]`).classList.add('active');
            
            if (tab === 'list') {
                loadGatePasses(true);
            }
        }

        function showNotification(message, type = 'success') {
            const el = document.getElementById('notification');
            const msgEl = document.getElementById('notificationMessage');
            el.className = `notification ${type}`;
            msgEl.textContent = message;
            el.classList.add('show');
            setTimeout(() => { el.classList.remove('show'); }, 3000);
        }

        // Cache functions
        function getCache(key) {
            try { const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : null; } catch { return null; }
        }
        function setCache(key, value) {
            try { localStorage.setItem(key, JSON.stringify(value)); } catch {}
        }

        // Load items from itemmaster for dropdown
        async function loadItemsForDropdown() {
            // Try cache first
            const cache = getCache('cache_itemmaster');
            if (cache && Array.isArray(cache.items)) {
                itemsArray = cache.items;
            }
            try {
                const qItems = query(collection(db, 'itemmaster'), orderBy('itemName'));
                const snapshot = await getDocs(qItems);

                itemsArray = [];
                snapshot.forEach(doc => {
                    const item = doc.data();
                    itemsArray.push({
                        id: doc.id,
                        itemName: item.itemName,
                        itemCode: item.serialNo,
                        unit: item.unit,
                        itemType: item.itemType,
                        currentStock: item.currentStock || 0
                    });
                });
                setCache('cache_itemmaster', { lastFetched: Date.now(), items: itemsArray });
                console.log('Loaded items:', itemsArray.length);
            } catch (error) {
                console.error('Error loading items:', error);
            }
        }

        // Load parties from partymaster for dropdown
        async function loadPartiesForDropdown() {
            // Try cache first
            const cache = getCache('cache_partymaster');
            if (cache && Array.isArray(cache.items)) {
                partyArray = cache.items;
            }
            try {
                const qParties = query(collection(db, 'partymaster'), orderBy('partyName'));
                const partySnap = await getDocs(qParties);
                const fresh = [];
                partySnap.forEach(d => {
                    const p = d.data();
                    fresh.push({ id: d.id, partyName: p.partyName, partyId: p.partyId, contactPerson: p.contactPerson, phoneNumber: p.phoneNumber, address: p.address, partyType: p.partyType });
                });
                partyArray = fresh;
                setCache('cache_partymaster', { lastFetched: Date.now(), items: partyArray });
                console.log('Loaded parties:', partyArray.length);
            } catch (err) { console.error('Error preloading parties:', err); }
        }

        // Right-side search panel + typeahead for any input
        function formatTs(ts) {
            if (!ts) return '';
            try { const d = new Date(ts); return `${d.toLocaleDateString()} ${d.toLocaleTimeString()}`; } catch { return ''; }
        }

        function renderSearchPanel(title, items, formatter, onSelect, metaKey) {
            console.log('Rendering search panel:', title, 'items:', items.length);
            const panel = document.getElementById('searchPanel');
            const titleEl = document.getElementById('searchPanelTitle');
            const metaEl = document.getElementById('searchPanelMeta');
            const refreshBtn = document.getElementById('searchPanelRefresh');
            const hintEl = document.getElementById('searchPanelHint');
            const list = document.getElementById('searchPanelList');
            
            if (!panel || !titleEl || !list) {
                console.error('Search panel elements not found');
                return;
            }
            
            titleEl.textContent = title;
            const cache = getCache(metaKey);
            metaEl.textContent = cache && cache.lastFetched ? `Last fetched: ${formatTs(cache.lastFetched)}` : '';
            list.innerHTML = '';
            items.forEach((it, idx) => {
                const li = document.createElement('li');
                li.className = 'right-search-item';
                li.tabIndex = 0;
                li.dataset.index = String(idx);
                li.innerHTML = formatter(it);
                li.addEventListener('click', () => { onSelect(it); });
                li.addEventListener('keydown', (ev) => {
                    if (ev.key === 'Enter') { ev.preventDefault(); onSelect(it); }
                    if (ev.key === 'ArrowDown') {
                        ev.preventDefault(); const next = li.nextElementSibling; if (next) next.focus();
                    }
                    if (ev.key === 'ArrowUp') {
                        ev.preventDefault(); const prev = li.previousElementSibling; if (prev) prev.focus();
                    }
                });
                list.appendChild(li);
            });
            panel.classList.add('show');
            console.log('Search panel shown with', items.length, 'items');

            // Show new day hint if applicable
            hintEl.style.display = 'none';
            const last = cache && cache.lastFetched ? new Date(cache.lastFetched) : null;
            const now = new Date();
            if (!last || last.toDateString() !== now.toDateString()) {
                hintEl.textContent = 'Data may be from a previous day. Click refresh to fetch today\'s data.';
                hintEl.style.display = 'inline-block';
                setTimeout(() => { hintEl.style.display = 'none'; }, 4000);
            }

            // Wire refresh
            refreshBtn.onclick = async () => {
                if (metaKey === 'cache_itemmaster') {
                    await refreshItems();
                } else if (metaKey === 'cache_partymaster') {
                    await refreshParties();
                }
                hideSearchPanel();
            };
        }

        async function refreshItems() {
            try {
                const qItems = query(collection(db, 'itemmaster'), orderBy('itemName'));
                const snapshot = await getDocs(qItems);
                const fresh = [];
                snapshot.forEach(d => { const it = d.data(); fresh.push({ id: d.id, itemName: it.itemName, itemCode: it.serialNo, unit: it.unit, itemType: it.itemType, currentStock: it.currentStock || 0 }); });
                itemsArray = fresh;
                setCache('cache_itemmaster', { lastFetched: Date.now(), items: itemsArray });
                console.log('Refreshed items:', itemsArray.length);
            } catch (e) { console.error('refreshItems error', e); }
        }

        async function refreshParties() {
            try {
                const qParties = query(collection(db, 'partymaster'), orderBy('partyName'));
                const snap = await getDocs(qParties);
                const fresh = [];
                snap.forEach(d => { const p = d.data(); fresh.push({ id: d.id, partyName: p.partyName, partyId: p.partyId, contactPerson: p.contactPerson, phoneNumber: p.phoneNumber, address: p.address, partyType: p.partyType }); });
                partyArray = fresh;
                setCache('cache_partymaster', { lastFetched: Date.now(), items: partyArray });
                console.log('Refreshed parties:', partyArray.length);
            } catch (e) { console.error('refreshParties error', e); }
        }

        function hideSearchPanel() {
            const panel = document.getElementById('searchPanel');
            panel.classList.remove('show');
        }

        // Single global click handler to avoid flicker
        document.addEventListener('mousedown', (e) => {
            const panel = document.getElementById('searchPanel');
            const partyInput = document.getElementById('partyName');
            const itemInput = document.getElementById('itemName');
            const clickedInsideInputs = (partyInput && partyInput.contains(e.target)) || itemInput.contains(e.target);
            const clickedInsidePanel = panel.contains(e.target);
            if (!clickedInsideInputs && !clickedInsidePanel) {
                hideSearchPanel();
            }
        });

        function focusNextField(currentId) {
            const form = document.getElementById('gatePassForm');
            const focusables = Array.from(form.querySelectorAll('input, select, textarea, button'))
                .filter(el => !el.disabled && el.type !== 'hidden');
            const idx = focusables.findIndex(el => el.id === currentId);
            if (idx >= 0 && idx + 1 < focusables.length) {
                focusables[idx + 1].focus();
            }
        }

        function setupTypeahead({ inputId, source, title, formatter, onPick, refreshFunction, cacheKey }) {
            const input = document.getElementById(inputId);
            console.log('Setting up typeahead for:', inputId, title);
            
            async function ensureDatasetLoaded() {
                const arr = source();
                console.log('Dataset loaded:', inputId, 'count:', arr ? arr.length : 0);
                if (!arr || arr.length === 0) {
                    console.log('Refreshing data for:', inputId);
                    await refreshFunction();
                }
            }
            input.addEventListener('mousedown', (e) => {
                // prevent blur during click
                e.preventDefault();
                input.focus();
            });
            input.addEventListener('focus', async () => {
                console.log('Focus event on:', inputId);
                await ensureDatasetLoaded();
                const arr = source();
                console.log('Showing panel for:', inputId, 'items:', arr ? arr.length : 0);
                if (arr && arr.length) {
                    const initial = arr.slice(0, 200);
                    renderSearchPanel(title, initial, (x) => formatter(x), (picked) => {
                        onPick(picked);
                        hideSearchPanel();
                        focusNextField(inputId);
                    }, cacheKey);
                } else {
                    console.log('No data to show for:', inputId);
                }
            });
            input.addEventListener('input', () => {
                const q = input.value.trim().toLowerCase();
                const arr = source();
                let matches;
                if (q.length < 3) {
                    matches = (arr || []).slice(0, 200);
                } else {
                    matches = (arr || []).filter(x => formatter(x).toLowerCase().includes(q)).slice(0, 200);
                }
                if (!matches || matches.length === 0) { hideSearchPanel(); return; }
                renderSearchPanel(title, matches, (x) => formatter(x), (picked) => {
                    onPick(picked);
                    hideSearchPanel();
                    focusNextField(inputId);
                }, cacheKey);
            });
            input.addEventListener('keydown', (ev) => {
                if (ev.key === 'ArrowDown') {
                    const first = document.querySelector('#searchPanelList .right-search-item');
                    if (first) { ev.preventDefault(); document.getElementById('searchPanel').classList.add('show'); first.focus(); }
                }
            });
        }

        // Validation functions
        function validateItemName(itemName) {
            if (!itemName || itemName.trim() === '') return { valid: true };
            
            const item = itemsArray.find(i => i.itemName.toLowerCase() === itemName.toLowerCase());
            if (!item) {
                return { valid: false, message: 'Item name not found. Please select from the list.' };
            }
            return { valid: true, item };
        }

        function validatePartyName(partyName) {
            if (!partyName || partyName.trim() === '') return { valid: true };
            
            const party = partyArray.find(p => p.partyName.toLowerCase() === partyName.toLowerCase());
            if (!party) {
                return { valid: false, message: 'Party name not found. Please select from the list.' };
            }
            return { valid: true, party };
        }
        
        function showFieldError(fieldId, message) {
            const field = document.getElementById(fieldId);
            const errorDiv = document.getElementById(fieldId + 'Error');
            
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            } else {
                // Create error div if it doesn't exist
                const error = document.createElement('div');
                error.id = fieldId + 'Error';
                error.className = 'field-error';
                error.textContent = message;
                error.style.color = '#dc3545';
                error.style.fontSize = '12px';
                error.style.marginTop = '2px';
                field.parentNode.insertBefore(error, field.nextSibling);
            }
            
            field.style.borderColor = '#dc3545';
        }
        
        function clearFieldError(fieldId) {
            const field = document.getElementById(fieldId);
            const errorDiv = document.getElementById(fieldId + 'Error');
            
            if (errorDiv) {
                errorDiv.style.display = 'none';
            }
            
            field.style.borderColor = '';
        }

        // Generate a candidate alphanumeric gate pass no, prefixed for readability
        function generateGatePassCodePrefix() {
            const y = new Date().getFullYear().toString().slice(-2);
            const m = String(new Date().getMonth() + 1).padStart(2, '0');
            const d = String(new Date().getDate()).padStart(2, '0');
            return `GP${y}${m}${d}`; // e.g., GP250917
        }

        async function generateUniqueGatePassNo() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            const prefix = generateGatePassCodePrefix();
            let attempts = 0;
            const maxAttempts = 100;
            while (attempts < maxAttempts) {
                let suffix = '';
                for (let i = 0; i < 4; i++) {
                    suffix += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                const code = `${prefix}-${suffix}`;

                try {
                    const snapshot = await getDocs(query(
                        collection(db, 'gatepasses'),
                        where('gatePassNo', '==', code),
                        qLimit(1)
                    ));
                    if (snapshot.empty) {
                        return code;
                    }
                } catch (err) {
                    // On read errors, fall back to using the generated code to avoid blocking UX
                    console.error('Uniqueness check failed, using generated code anyway:', err);
                    return code;
                }
                attempts++;
            }
            // If many collisions, add millis suffix
            return `${prefix}-${Date.now().toString().slice(-4)}`;
        }

        async function loadItemsAndParties() {
            // This function is kept for compatibility but not used for the new typeahead system
            // The new system uses loadPartiesForDropdown() and loadItemsForDropdown()
            // No DOM manipulation needed here since we're using the typeahead system
        }

        // Old parsing functions removed - now using typeahead system

        async function resetForm() {
            document.getElementById('gatePassForm').reset();
            document.getElementById('status').value = 'PENDING';
            
            // Clear hidden fields
            document.getElementById('partyDocId').value = '';
            document.getElementById('partyCodeHidden').value = '';
            document.getElementById('itemDocId').value = '';
            document.getElementById('itemIdHidden').value = '';
            
            // Clear any field errors
            clearFieldError('partyName');
            clearFieldError('itemName');
            
            // Reset button text and remove edit ID
            document.getElementById('saveBtn').textContent = 'Save Gate Pass';
            delete document.getElementById('gatePassForm').dataset.editId;
            
            // Generate a fresh unique Gate Pass No
            const code = await generateUniqueGatePassNo();
            document.getElementById('gatePassNo').value = code;
        }

        document.addEventListener('DOMContentLoaded', async function() {
            const userEmail = localStorage.getItem('userEmail');
            const userId = localStorage.getItem('userId');
            if (!userEmail || !userId) {
                window.location.href = 'login.html';
                return;
            }

            loadMenu();
            document.getElementById('welcomeMessage').textContent = `Welcome, ${userEmail}`;

            // Load items and parties for dropdown
            await loadItemsForDropdown();
            await loadPartiesForDropdown();
            
            // Load parties for dropdown (keep existing system for now)
            await loadItemsAndParties();
            
            // Setup typeahead for party name
            setupTypeahead({
                inputId: 'partyName',
                source: () => partyArray,
                title: 'Select Party',
                formatter: (p) => `${p.partyName}${p.partyId ? ' ‚Äî ' + p.partyId : ''}${p.contactPerson ? ' | ' + p.contactPerson : ''}`,
                onPick: (p) => {
                    document.getElementById('partyName').value = p.partyName;
                    document.getElementById('partyDocId').value = p.id || '';
                    document.getElementById('partyCodeHidden').value = p.partyId || '';
                },
                refreshFunction: refreshParties,
                cacheKey: 'cache_partymaster'
            });
            
            // Setup typeahead for item name
            setupTypeahead({
                inputId: 'itemName',
                source: () => itemsArray,
                title: 'Select Item',
                formatter: (it) => `${it.itemName} ${it.itemCode ? '(' + it.itemCode + ')' : ''}`,
                onPick: (it) => {
                    document.getElementById('itemName').value = it.itemName;
                    document.getElementById('itemCode').value = it.itemCode || '';
                    document.getElementById('itemDocId').value = it.id || '';
                    document.getElementById('itemIdHidden').value = it.itemCode || '';
                },
                refreshFunction: refreshItems,
                cacheKey: 'cache_itemmaster'
            });

            await resetForm();

            // Clear errors when user starts typing
            document.getElementById('partyName').addEventListener('input', function() {
                clearFieldError('partyName');
            });
            
            document.getElementById('itemName').addEventListener('input', function() {
                clearFieldError('itemName');
            });

            if (window.VersionManager) {
                VersionManager.checkForUpdates();
            }

            // Setup list tab event listeners
            setupListEventListeners();
        });

        // Setup event listeners for list tab
        function setupListEventListeners() {
            // Search button click
            document.getElementById('searchBtn').addEventListener('click', function() {
                // Update current filters from form values
                currentFilters.partyName = document.getElementById('searchPartyName').value.toLowerCase();
                currentFilters.itemName = document.getElementById('searchItemName').value.toLowerCase();
                currentFilters.gatePassNo = document.getElementById('searchGatePassNo').value.toLowerCase();
                currentFilters.type = document.getElementById('searchType').value;
                currentFilters.returnable = document.getElementById('searchReturnable').value;
                currentFilters.status = document.getElementById('searchStatus').value;

                // Reset pagination and reload
                hasMore = true;
                lastVisible = null;
                document.getElementById('noMore').style.display = 'none';
                loadGatePasses(true);
            });

            // Refresh button click
            document.getElementById('refreshBtn').addEventListener('click', function() {
                // Reset all filters to default values
                document.getElementById('searchPartyName').value = '';
                document.getElementById('searchItemName').value = '';
                document.getElementById('searchGatePassNo').value = '';
                document.getElementById('searchType').value = '';
                document.getElementById('searchReturnable').value = '';
                document.getElementById('searchStatus').value = '';

                // Reset all filters to default values
                currentFilters = {
                    partyName: '',
                    itemName: '',
                    gatePassNo: '',
                    type: '',
                    returnable: '',
                    status: ''
                };

                // Reset pagination and reload
                hasMore = true;
                lastVisible = null;
                document.getElementById('noMore').style.display = 'none';
                loadGatePasses(true);
                
                showNotification('Filters reset and data refreshed!');
            });

            // Download Excel button
            document.getElementById('downloadExcelBtn').addEventListener('click', function() {
                downloadExcelData();
            });
        }

        // Load gate passes with pagination and filters
        async function loadGatePasses(reset = false) {
            if (isLoading || (!hasMore && !reset)) return;
            
            try {
                isLoading = true;
                document.getElementById('loading').style.display = 'block';
                
                let q = query(collection(db, 'gatepasses'), orderBy('createdAt', 'desc'));
                
                if (lastVisible && !reset) {
                    q = query(q, qStartAfter(lastVisible));
                }
                
                q = query(q, qLimit(20));
                
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    hasMore = false;
                    document.getElementById('noMore').style.display = 'block';
                } else {
                    lastVisible = snapshot.docs[snapshot.docs.length - 1];
                    
                    const tbody = document.getElementById('gatePassTableBody');
                    
                    if (reset) {
                        tbody.innerHTML = '';
                    }
                    
                    snapshot.docs.forEach(doc => {
                        const gatePass = doc.data();
                        
                        // Apply filters
                        let matches = true;
                        
                        if (currentFilters.partyName && !gatePass.partyName.toLowerCase().includes(currentFilters.partyName)) {
                            matches = false;
                        }
                        
                        if (currentFilters.itemName && !gatePass.itemName.toLowerCase().includes(currentFilters.itemName)) {
                            matches = false;
                        }
                        
                        if (currentFilters.gatePassNo && !gatePass.gatePassNo.toLowerCase().includes(currentFilters.gatePassNo)) {
                            matches = false;
                        }
                        
                        if (currentFilters.type && gatePass.type !== currentFilters.type) {
                            matches = false;
                        }
                        
                        if (currentFilters.returnable && gatePass.returnable !== currentFilters.returnable) {
                            matches = false;
                        }
                        
                        if (currentFilters.status && gatePass.status !== currentFilters.status) {
                            matches = false;
                        }
                        
                        if (matches) {
                            const tr = document.createElement('tr');
                            tr.setAttribute('data-id', doc.id);
                            tr.innerHTML = `
                                <td>${gatePass.gatePassNo || ''}</td>
                                <td>${gatePass.partyName || ''}</td>
                                <td>${gatePass.itemName || ''}</td>
                                <td>${gatePass.itemCode || ''}</td>
                                <td>${gatePass.type || ''}</td>
                                <td>${gatePass.returnable || ''}</td>
                                <td>${gatePass.status || ''}</td>
                                <td>${gatePass.remarks || ''}</td>
                                <td>${gatePass.createdBy || ''}</td>
                                <td>${gatePass.createdAt ? new Date(gatePass.createdAt.seconds * 1000).toLocaleString() : ''}</td>
                                <td>
                                    <button class="action-btn edit-btn" onclick="editGatePass('${doc.id}')" title="Edit">‚úèÔ∏è</button>
                                    <button class="action-btn delete-btn" onclick="deleteGatePass('${doc.id}')" title="Delete">üóëÔ∏è</button>
                                </td>
                            `;
                            tbody.appendChild(tr);
                        }
                    });
                }
                
                document.getElementById('loading').style.display = 'none';
                isLoading = false;
                
            } catch (error) {
                console.error('Error loading gate passes:', error);
                showNotification('Error loading gate passes. Please try again.', 'error');
                document.getElementById('loading').style.display = 'none';
                isLoading = false;
            }
        }

        // Infinite scroll
        window.addEventListener('scroll', () => {
            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 1000) {
                loadGatePasses();
            }
        });

        // Edit gate pass
        window.editGatePass = async function(docId) {
            try {
                const docRef = doc(db, 'gatepasses', docId);
                const docSnap = await getDoc(docRef);

                const gatePass = docSnap.data();
                
                // Fill the form with gate pass data
                document.getElementById('gatePassNo').value = gatePass.gatePassNo || '';
                document.getElementById('partyName').value = gatePass.partyName || '';
                document.getElementById('partyDocId').value = gatePass.partyDocId || '';
                document.getElementById('partyCodeHidden').value = gatePass.partyCode || '';
                document.getElementById('itemName').value = gatePass.itemName || '';
                document.getElementById('itemCode').value = gatePass.itemCode || '';
                document.getElementById('itemDocId').value = gatePass.itemDocId || '';
                document.getElementById('itemIdHidden').value = gatePass.itemId || '';
                document.getElementById('type').value = gatePass.type || '';
                document.getElementById('returnable').value = gatePass.returnable || '';
                document.getElementById('remarks').value = gatePass.remarks || '';
                document.getElementById('status').value = gatePass.status || 'PENDING';
                
                // Set edit mode
                document.getElementById('gatePassForm').dataset.editId = docId;
                document.getElementById('saveBtn').textContent = 'Update Gate Pass';
                
                // Switch to form tab
                window.switchTab('form');
            } catch (error) {
                console.error('Error loading gate pass:', error);
                showNotification('Error loading gate pass details. Please try again.', 'error');
            }
        }

        // Delete gate pass
        window.deleteGatePass = async function(docId) {
            if (!confirm('Are you sure you want to delete this gate pass?')) {
                return;
            }

            try {
                await deleteDoc(doc(db, 'gatepasses', docId));
                showNotification('Gate pass deleted successfully!');
                
                // Remove row from table
                const row = document.querySelector(`tr[data-id='${docId}']`);
                if (row) { row.remove(); }
                hasMore = true; lastVisible = null; document.getElementById('noMore').style.display = 'none';
                loadGatePasses(true);
            } catch (error) {
                console.error('Error deleting gate pass:', error);
                showNotification('Error deleting gate pass. Please try again.', 'error');
            }
        }

        // Download Excel data
        function downloadExcelData() {
            const table = document.getElementById('gatePassTable');
            const rows = Array.from(table.querySelectorAll('tbody tr')).filter(row => 
                !row.querySelector('td[colspan]') // Exclude "No gate passes found" row
            );
            
            if (rows.length === 0) {
                showNotification('No data to export', 'error');
                return;
            }
            
            const headers = [
                'Gate Pass No', 'Party Name', 'Item Name', 'Item Code', 'Type', 
                'Returnable', 'Status', 'Remarks', 'Created By', 'Created At'
            ];
            
            const data = rows.map(row => {
                const cells = row.querySelectorAll('td');
                return [
                    cells[0].textContent,
                    cells[1].textContent,
                    cells[2].textContent,
                    cells[3].textContent,
                    cells[4].textContent,
                    cells[5].textContent,
                    cells[6].textContent,
                    cells[7].textContent,
                    cells[8].textContent,
                    cells[9].textContent
                ];
            });
            
            const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Gate Passes');
            
            const fileName = `gatepasses_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showNotification('Excel file downloaded successfully!');
        }

        document.getElementById('gatePassForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const userId = localStorage.getItem('userId');
            const gatePassNo = document.getElementById('gatePassNo').value.trim();
            const type = document.getElementById('type').value;
            const returnable = document.getElementById('returnable').value;
            const remarks = document.getElementById('remarks').value;
            const status = document.getElementById('status').value;

            // Clear any previous errors
            clearFieldError('partyName');
            clearFieldError('itemName');

            // Validate party name if provided
            const partyName = document.getElementById('partyName').value.trim();
            if (partyName) {
                const partyValidation = validatePartyName(partyName);
                if (!partyValidation.valid) {
                    showFieldError('partyName', partyValidation.message);
                    return;
                }
            }

            // Validate item name if provided
            const itemName = document.getElementById('itemName').value.trim();
            if (itemName) {
                const itemValidation = validateItemName(itemName);
                if (!itemValidation.valid) {
                    showFieldError('itemName', itemValidation.message);
                    return;
                }
            }

            if (!partyName) { showNotification('Please select a valid party from the list.', 'error'); return; }
            if (!itemName) { showNotification('Please select a valid item from the list.', 'error'); return; }
            if (!type) { showNotification('Please select type (IN/OUT).', 'error'); return; }
            if (!returnable) { showNotification('Please select returnable (RETURNABLE/NON RETURNABLE).', 'error'); return; }

            // Ensure gatePassNo uniqueness just before save
            try {
                const existing = await getDocs(query(
                    collection(db, 'gatepasses'),
                    where('gatePassNo', '==', gatePassNo),
                    qLimit(1)
                ));
                let finalGatePassNo = gatePassNo;
                if (!existing.empty) {
                    finalGatePassNo = await generateUniqueGatePassNo();
                }

                const payload = {
                    gatePassNo: finalGatePassNo,
                    type,
                    returnable,
                    remarks,
                    status: 'PENDING',
                    partyName: partyName,
                    partyDocId: document.getElementById('partyDocId').value,
                    partyCode: document.getElementById('partyCodeHidden').value,
                    itemName: itemName,
                    itemCode: document.getElementById('itemCode').value,
                    itemDocId: document.getElementById('itemDocId').value,
                    itemId: document.getElementById('itemIdHidden').value,
                    createdBy: userId,
                    createdAt: new Date(),
                    updatedAt: new Date()
                };

                const editId = document.getElementById('gatePassForm').dataset.editId;
                
                if (editId) {
                    // Update existing gate pass
                    await updateDoc(doc(db, 'gatepasses', editId), payload);
                    showNotification('Gate Pass updated successfully!');
                } else {
                    // Create new gate pass
                    await addDoc(collection(db, 'gatepasses'), payload);
                    showNotification('Gate Pass saved successfully!');
                }

                await resetForm();
                
                // Refresh the list if we're in edit mode
                if (editId) {
                    loadGatePasses(true);
                }
            } catch (error) {
                console.error('Error saving gate pass:', error);
                showNotification('Error saving gate pass. Please try again.', 'error');
            }
        });
    </script>
</body>
</html>


